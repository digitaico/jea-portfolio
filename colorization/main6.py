mport cv2
import numpy as np
import pandas as pd
import os

def hex_to_bgr(hex_color: str) -> tuple[int, int, int]:
        """
            Converts a hexadecimal color string (e.g., '#RRGGBB') to a BGR 
            tuple.
                Returns (B, G, R) where each component is 0-255.
                    """
                        hex_color = hex_color.lstrip('#')
                            if not all(c in '0123456789abcdefABCDEF' for c in 
                                       hex_color) or len(hex_color) != 6:
                                        raise ValueError(f"Invalid hex color 
                                        format: {hex_color}. Expected 
                                        '#RRGGBB'.")
                                            return tuple(int(hex_color[i:i+2], 
                                                             16) for i in (4, 
                                                                           2, 
                                                                           0)) 
                                                             # BGR

                                                             def 
                                                             colorize_image_with_masks_mvp(template_path: 
                                                                                           str, 
                                                                                           body_mask_path: 
                                                                                           str, 
                                                                                           pockets_mask_path: 
                                                                                           str, 
                                                                                           webbings_mask_path: 
                                                                                           str, 
                                                                                           output_dir: 
                                                                                           str, 
                                                                                           color_combinations_df: 
                                                                                           pd.DataFrame):
                                                                     """
                                                                         Colorizes 
                                                                         an 
                                                                         image 
                                                                         using 
                                                                         provided 
                                                                         masks 
                                                                         and 
                                                                         color 
                                                                         combinations,
                                                                             applying 
                                                                             colors 
                                                                             using 
                                                                             Lab 
                                                                             color 
                                                                             space 
                                                                             luminosity 
                                                                             transfer.

                                                                                 Args:
                                                                                             template_path 
                                                                                             (str): 
                                                                                             Path 
                                                                                             to 
                                                                                             the 
                                                                                             template 
                                                                                             image 
                                                                                             (e.g., 
                                                                                             'assets/template.jpg').
                                                                                                     body_mask_path 
                                                                                                     (str): 
                                                                                                     Path 
                                                                                                     to 
                                                                                                     the 
                                                                                                     body 
                                                                                                     mask 
                                                                                                     image 
                                                                                                     (e.g., 
                                                                                                     'assets/body_mask.png').
                                                                                                             pockets_mask_path 
                                                                                                             (str): 
                                                                                                             Path 
                                                                                                             to 
                                                                                                             the 
                                                                                                             pockets 
                                                                                                             mask 
                                                                                                             image 
                                                                                                             (e.g., 
                                                                                                             'assets/pockets_mask.png').
                                                                                                                     webbings_mask_path 
                                                                                                                     (str): 
                                                                                                                     Path 
                                                                                                                     to 
                                                                                                                     the 
                                                                                                                     webbings 
                                                                                                                     mask 
                                                                                                                     image 
                                                                                                                     (e.g., 
                                                                                                                     'assets/webbings_mask.png').
                                                                                                                             output_dir 
                                                                                                                             (str): 
                                                                                                                             Directory 
                                                                                                                             to 
                                                                                                                             save 
                                                                                                                             the 
                                                                                                                             output 
                                                                                                                             images.
                                                                                                                                     color_combinations_df 
                                                                                                                                     (pd.DataFrame): 
                                                                                                                                     DataFrame 
                                                                                                                                     containing 
                                                                                                                                     color 
                                                                                                                                     combinations.
                                                                                                                                         """
                                                                                                                                             if 
                                                                                                                                             not 
                                                                                                                                             os.path.exists(output_dir):
                                                                                                                                                         os.makedirs(output_dir)

                                                                                                                                                             # Load 
                                                                                                                                                             the 
                                                                                                                                                             template 
                                                                                                                                                             image
                                                                                                                                                                 template_img 
                                                                                                                                                                 = cv2.imread(template_path)
                                                                                                                                                                     if 
                                                                                                                                                                     template_img 
                                                                                                                                                                     is 
                                                                                                                                                                     None:
                                                                                                                                                                                 print(f"Error: 
                                                                                                                                                                                 Could 
                                                                                                                                                                                 not 
                                                                                                                                                                                 load 
                                                                                                                                                                                 template 
                                                                                                                                                                                 image 
                                                                                                                                                                                 at 
                                                                                                                                                                                 {template_path}")
                                                                                                                                                                                         return

                                                                                                                                                                                         # Load 
                                                                                                                                                                                         masks
                                                                                                                                                                                             body_mask 
                                                                                                                                                                                             = cv2.imread(body_mask_path, 
                                                                                                                                                                                                          cv2.IMREAD_GRAYSCALE)
                                                                                                                                                                                                 pockets_mask 
                                                                                                                                                                                                 = cv2.imread(pockets_mask_path, 
                                                                                                                                                                                                              cv2.IMREAD_GRAYSCALE)
                                                                                                                                                                                                     webbings_mask 
                                                                                                                                                                                                     = cv2.imread(webbings_mask_path, 
                                                                                                                                                                                                                  cv2.IMREAD_GRAYSCALE)

                                                                                                                                                                                                         if 
                                                                                                                                                                                                         body_mask 
                                                                                                                                                                                                         is 
                                                                                                                                                                                                         None 
                                                                                                                                                                                                         or 
                                                                                                                                                                                                         pockets_mask 
                                                                                                                                                                                                         is 
                                                                                                                                                                                                         None 
                                                                                                                                                                                                         or 
                                                                                                                                                                                                         webbings_mask 
                                                                                                                                                                                                         is 
                                                                                                                                                                                                         None:
                                                                                                                                                                                                                     print("Error: 
                                                                                                                                                                                                                     One 
                                                                                                                                                                                                                     or 
                                                                                                                                                                                                                     more 
                                                                                                                                                                                                                     masks 
                                                                                                                                                                                                                     could 
                                                                                                                                                                                                                     not 
                                                                                                                                                                                                                     be 
                                                                                                                                                                                                                     loaded.  
                                                                                                                                                                                                                     Please 
                                                                                                                                                                                                                     check 
                                                                                                                                                                                                                     paths.")
                                                                                                                                                                                                                             return

                                                                                                                                                                                                                             # Ensure 
                                                                                                                                                                                                                             masks 
                                                                                                                                                                                                                             are 
                                                                                                                                                                                                                             binary 
                                                                                                                                                                                                                             (0 
                                                                                                                                                                                                                              or 
                                                                                                                                                                                                                              255) 
                                                                                                                                                                                                                             and 
                                                                                                                                                                                                                             convert 
                                                                                                                                                                                                                             to 
                                                                                                                                                                                                                             3 channels 
                                                                                                                                                                                                                             for 
                                                                                                                                                                                                                             element-wise 
                                                                                                                                                                                                                             multiplication
                                                                                                                                                                                                                                 _, 
                                                                                                                                                                                                                                 body_mask 
                                                                                                                                                                                                                                 = cv2.threshold(body_mask, 
                                                                                                                                                                                                                                                 128, 
                                                                                                                                                                                                                                                 255, 
                                                                                                                                                                                                                                                 cv2.THRESH_BINARY)
                                                                                                                                                                                                                                     _, 
                                                                                                                                                                                                                                     pockets_mask 
                                                                                                                                                                                                                                     = cv2.threshold(pockets_mask, 
                                                                                                                                                                                                                                                     128, 
                                                                                                                                                                                                                                                     255, 
                                                                                                                                                                                                                                                     cv2.THRESH_BINARY)
                                                                                                                                                                                                                                         _, 
                                                                                                                                                                                                                                         webbings_mask 
                                                                                                                                                                                                                                         = cv2.threshold(webbings_mask, 
                                                                                                                                                                                                                                                         128, 
                                                                                                                                                                                                                                                         255, 
                                                                                                                                                                                                                                                         cv2.THRESH_BINARY)

                                                                                                                                                                                                                                             body_mask_3ch 
                                                                                                                                                                                                                                             = cv2.cvtColor(body_mask, 
                                                                                                                                                                                                                                                            cv2.COLOR_GRAY2BGR)
                                                                                                                                                                                                                                                 pockets_mask_3ch 
                                                                                                                                                                                                                                                 = cv2.cvtColor(pockets_mask, 
                                                                                                                                                                                                                                                                cv2.COLOR_GRAY2BGR)
                                                                                                                                                                                                                                                     webbings_mask_3ch 
                                                                                                                                                                                                                                                     = cv2.cvtColor(webbings_mask, 
                                                                                                                                                                                                                                                                    cv2.COLOR_GRAY2BGR)

                                                                                                                                                                                                                                                         # Determine 
                                                                                                                                                                                                                                                         the 
                                                                                                                                                                                                                                                         area 
                                                                                                                                                                                                                                                         that 
                                                                                                                                                                                                                                                         is 
                                                                                                                                                                                                                                                         the 
                                                                                                                                                                                                                                                         apparel 
                                                                                                                                                                                                                                                         (union 
                                                                                                                                                                                                                                                          of 
                                                                                                                                                                                                                                                          all 
                                                                                                                                                                                                                                                          masks)
                                                                                                                                                                                                                                                             apparel_mask_raw 
                                                                                                                                                                                                                                                             = cv2.bitwise_or(body_mask, 
                                                                                                                                                                                                                                                                              pockets_mask)
                                                                                                                                                                                                                                                                 apparel_mask_raw 
                                                                                                                                                                                                                                                                 = cv2.bitwise_or(apparel_mask_raw, 
                                                                                                                                                                                                                                                                                  webbings_mask)
                                                                                                                                                                                                                                                                     _, 
                                                                                                                                                                                                                                                                     apparel_mask_binary 
                                                                                                                                                                                                                                                                     = cv2.threshold(apparel_mask_raw, 
                                                                                                                                                                                                                                                                                     1, 
                                                                                                                                                                                                                                                                                     255, 
                                                                                                                                                                                                                                                                                     cv2.THRESH_BINARY) 
                                                                                                                                                                                                                                                                     # Ensure 
                                                                                                                                                                                                                                                                     it's 
                                                                                                                                                                                                                                                                     binary
                                                                                                                                                                                                                                                                         apparel_mask_3ch 
                                                                                                                                                                                                                                                                         = cv2.cvtColor(apparel_mask_binary, 
                                                                                                                                                                                                                                                                         cv2.COLOR_GRAY2BGR)
                                                                                                                                                                                                                                                                             background_mask_3ch 
                                                                                                                                                                                                                                                                             = cv2.bitwise_not(apparel_mask_3ch) 
                                                                                                                                                                                                                                                                             # For 
                                                                                                                                                                                                                                                                             white 
                                                                                                                                                                                                                                                                             background

                                                                                                                                                                                                                                                                                 # Extract 
                                                                                                                                                                                                                                                                                 the 
                                                                                                                                                                                                                                                                                 original 
                                                                                                                                                                                                                                                                                 webbings 
                                                                                                                                                                                                                                                                                 section 
                                                                                                                                                                                                                                                                                 (remains 
                                                                                                                                                                                                                                                                                 unchanged)
                                                                                                                                                                                                                                                                                     original_webbings 
                                                                                                                                                                                                                                                                                     = cv2.bitwise_and(template_img, 
                                                                                                                                                                                                                                                                                     webbings_mask_3ch)

                                                                                                                                                                                                                                                                                         # Convert 
                                                                                                                                                                                                                                                                                         the 
                                                                                                                                                                                                                                                                                         original 
                                                                                                                                                                                                                                                                                         template 
                                                                                                                                                                                                                                                                                         to 
                                                                                                                                                                                                                                                                                         Lab 
                                                                                                                                                                                                                                                                                         color 
                                                                                                                                                                                                                                                                                         space 
                                                                                                                                                                                                                                                                                         once
                                                                                                                                                                                                                                                                                             original_lab_img 
                                                                                                                                                                                                                                                                                             = cv2.cvtColor(template_img, 
                                                                                                                                                                                                                                                                                             cv2.COLOR_BGR2Lab)
                                                                                                                                                                                                                                                                                                 L_orig, 
                                                                                                                                                                                                                                                                                                 a_orig, 
                                                                                                                                                                                                                                                                                                 b_orig 
                                                                                                                                                                                                                                                                                                 = cv2.split(original_lab_img)


                                                                                                                                                                                                                                                                                                     for 
                                                                                                                                                                                                                                                                                                     index, 
                                                                                                                                                                                                                                                                                                     row 
                                                                                                                                                                                                                                                                                                     in 
                                                                                                                                                                                                                                                                                                     color_combinations_df.iterrows():
                                                                                                                                                                                                                                                                                                             filename 
                                                                                                                                                                                                                                                                                                             = row['filename']
                                                                                                                                                                                                                                                                                                                     body_color_hex 
                                                                                                                                                                                                                                                                                                                     = row['body_color']
                                                                                                                                                                                                                                                                                                                             pockets_color_hex 
                                                                                                                                                                                                                                                                                                                             = row['pockets_color']

                                                                                                                                                                                                                                                                                                                                     # --- 
                                                                                                                                                                                                                                                                                                                                     Colorize 
                                                                                                                                                                                                                                                                                                                                     Body 
                                                                                                                                                                                                                                                                                                                                     Section 
                                                                                                                                                                                                                                                                                                                                     using 
                                                                                                                                                                                                                                                                                                                                     Lab 
                                                                                                                                                                                                                                                                                                                                     Luminosity 
                                                                                                                                                                                                                                                                                                                                     Transfer 
                                                                                                                                                                                                                                                                                                                                     ---
                                                                                                                                                                                                                                                                                                                                             body_bgr 
                                                                                                                                                                                                                                                                                                                                             = hex_to_bgr(body_color_hex)
                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                             # Convert 
                                                                                                                                                                                                                                                                                                                                                             target 
                                                                                                                                                                                                                                                                                                                                                             body 
                                                                                                                                                                                                                                                                                                                                                             color 
                                                                                                                                                                                                                                                                                                                                                             to 
                                                                                                                                                                                                                                                                                                                                                             Lab 
                                                                                                                                                                                                                                                                                                                                                             to 
                                                                                                                                                                                                                                                                                                                                                             get 
                                                                                                                                                                                                                                                                                                                                                             its 
                                                                                                                                                                                                                                                                                                                                                             'a' 
                                                                                                                                                                                                                                                                                                                                                             and 
                                                                                                                                                                                                                                                                                                                                                             'b' 
                                                                                                                                                                                                                                                                                                                                                             channels
                                                                                                                                                                                                                                                                                                                                                                     target_body_lab_single_pixel 
                                                                                                                                                                                                                                                                                                                                                                     = cv2.cvtColor(np.array([[body_bgr]], 
                                                                                                                                                                                                                                                                                                                                                                     dtype=np.uint8), 
                                                                                                                                                                                                                                                                                                                                                                     cv2.COLOR_BGR2Lab)
                                                                                                                                                                                                                                                                                                                                                                             _, 
                                                                                                                                                                                                                                                                                                                                                                             a_target_body, 
                                                                                                                                                                                                                                                                                                                                                                             b_target_body 
                                                                                                                                                                                                                                                                                                                                                                             = cv2.split(target_body_lab_single_pixel)

                                                                                                                                                                                                                                                                                                                                                                                     # Create 
                                                                                                                                                                                                                                                                                                                                                                                     new 
                                                                                                                                                                                                                                                                                                                                                                                     'a' 
                                                                                                                                                                                                                                                                                                                                                                                     and 
                                                                                                                                                                                                                                                                                                                                                                                     'b' 
                                                                                                                                                                                                                                                                                                                                                                                     channels 
                                                                                                                                                                                                                                                                                                                                                                                     filled 
                                                                                                                                                                                                                                                                                                                                                                                     with 
                                                                                                                                                                                                                                                                                                                                                                                     the 
                                                                                                                                                                                                                                                                                                                                                                                     target 
                                                                                                                                                                                                                                                                                                                                                                                     body 
                                                                                                                                                                                                                                                                                                                                                                                     color's 
                                                                                                                                                                                                                                                                                                                                                                                     a/b 
                                                                                                                                                                                                                                                                                                                                                                                     values
                                                                                                                                                                                                                                                                                                                                                                                             a_new_body 
                                                                                                                                                                                                                                                                                                                                                                                             = np.full_like(a_orig, 
                                                                                                                                                                                                                                                                                                                                                                                                            a_target_body[0,0], 
                                                                                                                                                                                                                                                                                                                                                                                                            dtype=np.uint8)
                                                                                                                                                                                                                                                                                                                                                                                                     b_new_body 
                                                                                                                                                                                                                                                                                                                                                                                                     = np.full_like(b_orig, 
                                                                                                                                                                                                                                                                                                                                                                                                                    b_target_body[0,0], 
                                                                                                                                                                                                                                                                                                                                                                                                                    dtype=np.uint8)

                                                                                                                                                                                                                                                                                                                                                                                                             # Combine 
                                                                                                                                                                                                                                                                                                                                                                                                             original 
                                                                                                                                                                                                                                                                                                                                                                                                             L with 
                                                                                                                                                                                                                                                                                                                                                                                                             new 
                                                                                                                                                                                                                                                                                                                                                                                                             body 
                                                                                                                                                                                                                                                                                                                                                                                                             a/b, 
                                                                                                                                                                                                                                                                                                                                                                                                             convert 
                                                                                                                                                                                                                                                                                                                                                                                                             back 
                                                                                                                                                                                                                                                                                                                                                                                                             to 
                                                                                                                                                                                                                                                                                                                                                                                                             BGR
                                                                                                                                                                                                                                                                                                                                                                                                                     combined_lab_body 
                                                                                                                                                                                                                                                                                                                                                                                                                     = cv2.merge([L_orig, 
                                                                                                                                                                                                                                                                                                                                                                                                                                  a_new_body, 
                                                                                                                                                                                                                                                                                                                                                                                                                                  b_new_body])
                                                                                                                                                                                                                                                                                                                                                                                                                             colorized_body_bgr 
                                                                                                                                                                                                                                                                                                                                                                                                                             = cv2.cvtColor(combined_lab_body, 
                                                                                                                                                                                                                                                                                                                                                                                                                                            cv2.COLOR_Lab2BGR)
                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                     # Apply 
                                                                                                                                                                                                                                                                                                                                                                                                                                     body 
                                                                                                                                                                                                                                                                                                                                                                                                                                     mask 
                                                                                                                                                                                                                                                                                                                                                                                                                                     to 
                                                                                                                                                                                                                                                                                                                                                                                                                                     isolate 
                                                                                                                                                                                                                                                                                                                                                                                                                                     the 
                                                                                                                                                                                                                                                                                                                                                                                                                                     body 
                                                                                                                                                                                                                                                                                                                                                                                                                                     section
                                                                                                                                                                                                                                                                                                                                                                                                                                             body_section 
                                                                                                                                                                                                                                                                                                                                                                                                                                             = cv2.bitwise_and(colorized_body_bgr, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                               body_mask_3ch)


                                                                                                                                                                                                                                                                                                                                                                                                                                                     # --- 
                                                                                                                                                                                                                                                                                                                                                                                                                                                     Colorize 
                                                                                                                                                                                                                                                                                                                                                                                                                                                     Pockets 
                                                                                                                                                                                                                                                                                                                                                                                                                                                     Section 
                                                                                                                                                                                                                                                                                                                                                                                                                                                     using 
                                                                                                                                                                                                                                                                                                                                                                                                                                                     Lab 
                                                                                                                                                                                                                                                                                                                                                                                                                                                     Luminosity 
                                                                                                                                                                                                                                                                                                                                                                                                                                                     Transfer 
                                                                                                                                                                                                                                                                                                                                                                                                                                                     ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                             pockets_bgr 
                                                                                                                                                                                                                                                                                                                                                                                                                                                             = hex_to_bgr(pockets_color_hex)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # Convert 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     target 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     pockets 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     color 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     to 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Lab 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     to 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     get 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     its 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     'a' 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     and 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     'b' 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     channels
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             target_pockets_lab_single_pixel 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             = cv2.cvtColor(np.array([[pockets_bgr]], 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     dtype=np.uint8), 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cv2.COLOR_BGR2Lab)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     _, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     a_target_pockets, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     b_target_pockets 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     = cv2.split(target_pockets_lab_single_pixel)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             # Create 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             new 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             'a' 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             and 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             'b' 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             channels 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             filled 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             with 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             the 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             target 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             pockets 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             color's 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             a/b 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             values
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     a_new_pockets 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     = np.full_like(a_orig, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     a_target_pockets[0,0], 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     dtype=np.uint8)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             b_new_pockets 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             = np.full_like(b_orig, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             b_target_pockets[0,0], 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             dtype=np.uint8)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # Combine 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     original 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     L with 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     new 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     pockets 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     a/b, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     convert 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     back 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     to 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     BGR
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             combined_lab_pockets 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             = cv2.merge([L_orig, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             a_new_pockets, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             b_new_pockets])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     colorized_pockets_bgr 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     = cv2.cvtColor(combined_lab_pockets, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     cv2.COLOR_Lab2BGR)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             # Apply 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             pockets 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             mask 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             to 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             isolate 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             the 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             pockets 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             section
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     pockets_section 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     = cv2.bitwise_and(colorized_pockets_bgr, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     pockets_mask_3ch)


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             # --- 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Combine 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             All 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Layers 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             into 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Final 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Image 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # Start 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     with 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     a white 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     background 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     for 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     the 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     output 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     image
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             output_img 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             = np.full_like(template_img, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             (255, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             255, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             255), 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             dtype=np.uint8)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # Overlay 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     the 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     white 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     background 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     where 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     the 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apparel 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     is 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     not
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             output_img 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             = cv2.bitwise_and(output_img, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             background_mask_3ch)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             # Now, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             add 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             the 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             colored 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             body, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             pockets, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             and 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             original 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             webbings
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apparel_composite 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     = np.zeros_like(template_img, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     dtype=np.uint8)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             apparel_composite 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             = cv2.add(apparel_composite, body_section)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     apparel_composite 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     = cv2.add(apparel_composite, pockets_section)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             apparel_composite = cv2.add(apparel_composite, original_webbings)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # Add the combined apparel onto the background
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             final_image = cv2.add(output_img, apparel_composite)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # Save the result
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             output_path = os.path.join(output_dir, filename)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     cv2.imwrite(output_path, final_image)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             print(f"Generated: {output_path}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             # --- How to use the script (Main Execution Block) ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 # Define asset paths
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     assets_dir = 'assets'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         data_dir = 'data'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             output_dir = 'output_images_mvp' # Output directory for this MVP script

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 template_file = os.path.join(assets_dir, 'template.jpg')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     body_mask_file = os.path.join(assets_dir, 'body_mask.png')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         pockets_mask_file = os.path.join(assets_dir, 'pockets_mask.png')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             webbings_mask_file = os.path.join(assets_dir, 'webbings_mask.png')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 color_combinations_file = os.path.join(data_dir, 'color_combinations.csv')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # Load color combinations
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 color_df = pd.read_csv(color_combinations_file)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         # Basic validation for required columns
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 required_cols = ['filename', 'body_color', 'pockets_color']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if not all(col in color_df.columns for col in required_cols):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     print(f"Error: CSV is missing required columns. Expected: {required_cols}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 exit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     except FileNotFoundError:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             print(f"Error: color_combinations.csv not found at {color_combinations_file}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     exit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 print(f"Error reading CSV file {color_combinations_file}: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         exit()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             # Run the colorization process with Lab transfer
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 colorize_image_with_masks_mvp(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         template_file,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 body_mask_file,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         pockets_mask_file,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 webbings_mask_file,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         output_dir,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 color_df
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         print("\nMVP script execution complete. Check the 'output_images_mvp' directory.")